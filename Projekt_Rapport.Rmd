---
title: "MT5021 — Övningsprojekt A8 – Tillförsel av kväve till Östersjön"
output:
  html_document:
    toc: true
    toc_depth: 3
    df_print: paged
  pdf_document: default
---



**Projektnummer:** *[fyll i]*
**Projektnamn:** Tillförsel av kväve (DIN) till Östersjön
**Grupp:** Namn Efternamn, Namn Efternamn, Namn Efternamn
**Oktober 2025**

```{r setup, include=FALSE}
options(stringsAsFactors = FALSE)
set.seed(5021)
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```



```{r, results='hide'}
# Läs in data
dat_raw <- read.csv("baltic_DIN.csv", sep = ",", header = TRUE, check.names = FALSE)

# Arbetskopia
df <- dat_raw

# Enheter och nya namn
df$x1_area_km2 <- df$x1 * 0.01
df$x2_population <- df$x2
df$x3_urban_percent <- df$x3
df$x4_rural_percent <- df$x4
df$x5_population_density_km2 <- df$x5
df$x6_deciduous_forest_km2      <- df$x6  * 0.01
df$x7_coniferous_forest_km2     <- df$x7  * 0.01
df$x8_mixed_forest_km2          <- df$x8  * 0.01
df$x9_shrubland_km2             <- df$x9  * 0.01
df$x10_wetland_km2              <- df$x10 * 0.01
df$x11_agricultural_land_km2    <- df$x11 * 0.01
df$x12_bare_rock_km2            <- df$x12 * 0.01
df$x13_inland_water_km2         <- df$x13 * 0.01
df$x14_snow_ice_km2             <- df$x14 * 0.01
df$x15_artificial_surfaces_km2  <- df$x15 * 0.01
df$x16_runoff <- df$x16
df$x17_swine  <- df$x17
df$x18_cattle <- df$x18
df$x19_treatment_prop <- df$x19/100
df$x20_country <- df$x20
df$x20_country[is.na(df$x20_country) | df$x20_country == "" ] <- "MISSING"
df$x20_country <- factor(df$x20_country)
df$sweden_group <- factor(ifelse(df$x20_country == "SWEDEN", "Sweden", "Non-Sweden"),
                          levels = c("Non-Sweden","Sweden"))

# Hjälpfunktion för loggar
log1p_safe <- function(z) log1p(pmax(z, 0))

# Respons och loggar
df$y_log <- log1p_safe(df$y)
df$x1_area_km2_log    <- log1p_safe(df$x1_area_km2)
df$x2_population_log  <- log1p_safe(df$x2_population)
df$x17_swine_log      <- log1p_safe(df$x17_swine)
df$x18_cattle_log     <- log1p_safe(df$x18_cattle)

# Andelar av total area
area_total <- df$x1_area_km2
df$x6_deciduous_forest_prop     <- df$x6_deciduous_forest_km2     / area_total
df$x7_coniferous_forest_prop    <- df$x7_coniferous_forest_km2    / area_total
df$x8_mixed_forest_prop         <- df$x8_mixed_forest_km2         / area_total
df$x9_shrubland_prop            <- df$x9_shrubland_km2            / area_total
df$x10_wetland_prop             <- df$x10_wetland_km2             / area_total
df$x11_agricultural_land_prop   <- df$x11_agricultural_land_km2   / area_total
df$x12_bare_rock_prop           <- df$x12_bare_rock_km2           / area_total
df$x13_inland_water_prop        <- df$x13_inland_water_km2        / area_total
df$x14_snow_ice_prop            <- df$x14_snow_ice_km2            / area_total
df$x15_artificial_surfaces_prop <- df$x15_artificial_surfaces_km2 / area_total

# Loggar för areor (x6–x15)
df$x6_deciduous_forest_km2_log      <- log1p_safe(df$x6_deciduous_forest_km2)
df$x7_coniferous_forest_km2_log     <- log1p_safe(df$x7_coniferous_forest_km2)
df$x8_mixed_forest_km2_log          <- log1p_safe(df$x8_mixed_forest_km2)
df$x9_shrubland_km2_log             <- log1p_safe(df$x9_shrubland_km2)
df$x10_wetland_km2_log              <- log1p_safe(df$x10_wetland_km2)
df$x11_agricultural_land_km2_log    <- log1p_safe(df$x11_agricultural_land_km2)
df$x12_bare_rock_km2_log            <- log1p_safe(df$x12_bare_rock_km2)
df$x13_inland_water_km2_log         <- log1p_safe(df$x13_inland_water_km2)
df$x14_snow_ice_km2_log             <- log1p_safe(df$x14_snow_ice_km2)
df$x15_artificial_surfaces_km2_log  <- log1p_safe(df$x15_artificial_surfaces_km2)

# Lagrar sammanräkningar för inline-text
country_tbl  <- table(df$x20_country)
```


# 1 Sammanfattning

Vi analyserar sambanden mellan tillförsel av löst oorganiskt kväve (DIN) och demografiska, hydrologiska samt markanvändningsrelaterade faktorer i Östersjöns avrinningsområden. Data förbehandlas (enhetsbyten, loggar, andelar) och utforskas grafiskt. Linjära modeller med log-transformerad respons jämförs mot rå-respons och olika varianter av förklarande variabler. Variabelselektion görs med AIC, multikollinearitet kontrolleras med VIF och antaganden granskas med standarddiagnostik. Leave-One-Out CV med Duans smearing används för prediktion på kg-skalan. Resultaten visar att DIN främst ökar med befolkning, avrinning och antal svin, medan hög anslutning till reningsverk minskar DIN. Sverige har lägre grundnivå än övriga länder men samma lutningar. Den bästa prediktionsmodellen är log-respons med log-arealer (stepAIC).

# 2 Inledning

Målet är att modellera och jämföra hur DIN (dissolved inorganic nitrogen) i tillrinnande vattendrag påverkas av avrinningsområdets storlek, befolkning, markanvändning, djurhållning, avrinning samt reningsanslutning, och att bedöma om sambanden skiljer mellan Sverige och övriga länder. Vi utvärderar modeller både för inferens och prediktion (LOOCV).

# 3 Data

**Källa och struktur.** Datasetet `baltic_DIN.csv` består av avrinningsområden med variabler $x_1,\dots,x_{20}$ och respons $y$ (DIN, kg). Vi omvandlar areor från ha till km², bildar loggar och andelar enligt uppgift. Datakontroller (andelar, täthet, arealsummor) utföll väl utan avvikelser av praktisk betydelse.

**Länder och antal.** Datasetet omfattar $r$ `nlevels(df$x20_country)` länder:
`
paste(sprintf("%s (%d)", names(table(df$x20_country)), as.integer(table(df$x20_country))), collapse = ", "
`

**Variabler (urval).**

| Variabel   | Typ      | Beskrivning                                 |
| ---------- | -------- | ------------------------------------------- |
| $y$        | numerisk | DIN (kg)                                    |
| $x1$       | numerisk | Avrinningsområde (ha $\rightarrow$ km²)     |
| $x2$       | numerisk | Befolkning                                  |
| $x3,x4$    | numerisk | Andel stad/land (%)                         |
| $x5$       | numerisk | Befolkningstäthet (inv/km²)                 |
| $x6$–$x15$ | numerisk | Markanvändningsareor (ha $\rightarrow$ km²) |
| $x16$      | numerisk | Avrinning (mm/år)                           |
| $x17,x18$  | numerisk | Svin/Nöt (antal)                            |
| $x19$      | numerisk | Anslutning reningsverk (%)                  |
| $x20$      | char   | Land                                        |




## Data & Förberedelser

```{r, fig.width=7, fig.height=7}
numeric_x <- c("x1_area_km2","x2_population","x3_urban_percent","x5_population_density_km2",
               "x6_deciduous_forest_km2","x7_coniferous_forest_km2","x8_mixed_forest_km2",
               "x9_shrubland_km2","x10_wetland_km2","x11_agricultural_land_km2",
               "x12_bare_rock_km2","x13_inland_water_km2","x14_snow_ice_km2",
               "x15_artificial_surfaces_km2","x16_runoff","x17_swine","x18_cattle",
               "x19_treatment_prop")
par(mfrow=c(3,3), mar=c(4,4,2,1))
for (v in numeric_x) {
  plot(df[[v]], df$y, xlab=v, ylab="y (DIN, kg)", main=paste("y vs", v))
  abline(lm(df$y ~ df[[v]]), col="red", lwd=2)
}
```



```{r}
boxplot(y ~ x20_country, data=df, main="y by country", xlab="Country", ylab="y (kg)", las=2)
```

```{r}
hist(df$y, breaks="FD", main="Histogram of y (DIN, kg)", xlab="y (kg)")
```

# 4 Statistisk modellering

**Kommentar om kollinearitet.**
$x3+x4=100$ (perfekt kollinearitet). $x5$ är härledd ur $x2$ och $x1$. Summan av markandelsvariabler $x6$–$x15$ är $x1$, vilket ger nära-perfekt kollinearitet. Vi exkluderar $x4$, $x5$ och $x12$ enligt anvisning.

## 4.1 Grundläggande grafer

**Kort tolkning.** Positiva samband för area, befolkning, jordbruk, artificiella ytor, svin och nöt; negativt för reningsanslutning. $y$ är högerskev $\rightarrow$ log-transform.

```{r, fig.width=7, fig.height=7}
vars_trans <- c("x1_area_km2_log","x2_population_log","x3_urban_percent","x4_rural_percent","x5_population_density_km2",
                "x6_deciduous_forest_prop","x7_coniferous_forest_prop","x8_mixed_forest_prop",
                "x9_shrubland_prop","x10_wetland_prop","x11_agricultural_land_prop",
                "x13_inland_water_prop","x14_snow_ice_prop","x15_artificial_surfaces_prop",
                "x16_runoff","x17_swine_log","x18_cattle_log","x19_treatment_prop")
par(mfrow=c(3,3), mar=c(4,4,2,1))
for (v in vars_trans) {  
  plot(df[[v]], df$y_log, xlab=v, ylab="y_log", main=paste("y_log vs", v))
  abline(lm(df$y_log ~ df[[v]]), col="red", lwd=2)
}
```

```{r}
boxplot(y_log ~ x20_country, data=df, main="y_log by country", xlab="Country", ylab="y_log", las=2)
```

```{r}
hist(df$y_log, breaks="FD", main="Histogram of y_log (log-transformed DIN)", xlab="y_log")
```

**Kort tolkning (log-skala).** Starka samband för $x1_{\log},x2_{\log},x11_{%},x15_{%},x17_{\log},x18_{\log}$; negativt för $x19$; länder skiljer sig i nivå.

## 4.2 Fråga 1 — Samband i hela Östersjöområdet (log-respons)

**Full modell:**
$$
\begin{aligned}
y_{\log} \sim&\ x1_{\log}+x2_{\log}+x3+
(x6\text{–}x11,x13,x14,x15)_{%}\ (\text{utan }x12)\
&+,x16+x17_{\log}+x18_{\log}+x19+\text{land}.
\end{aligned}
$$

```{r}
form_full_log <- y_log ~ x1_area_km2_log + x2_population_log + x3_urban_percent +
  x6_deciduous_forest_prop + x7_coniferous_forest_prop + x8_mixed_forest_prop +
  x9_shrubland_prop + x10_wetland_prop + x11_agricultural_land_prop +
  x13_inland_water_prop + x14_snow_ice_prop + x15_artificial_surfaces_prop +
  x16_runoff + x17_swine_log + x18_cattle_log + x19_treatment_prop + x20_country
fit_full_log <- lm(form_full_log, data=df)
summary(fit_full_log)
```

**Stegvis AIC (båda riktningar).**

```{r}
fit_step_log <- MASS::stepAIC(fit_full_log, direction="both", trace=FALSE)
summary(fit_step_log)
```

### VIF-kontroll (numeriska prediktorer)

```{r}
vif_numeric <- function(model, data){
  tt <- terms(model)
  labs <- attr(tt, "term.labels")
  num_vars <- labs[sapply(labs, function(v) is.numeric(data[[v]]))]
  out <- setNames(numeric(length(num_vars)), num_vars)
  for (v in num_vars) {
    others <- setdiff(num_vars, v)
    if (length(others) == 0) { out[v] <- NA_real_; next }
    r2 <- summary(lm(as.formula(paste(v, "~", paste(others, collapse="+"))), data=data))$r.squared
    out[v] <- 1/(1 - r2)
  }
  out
}
vif_full_log <- vif_numeric(fit_full_log, df)
vif_step_log <- vif_numeric(fit_step_log, df)
vif_full_log; vif_step_log
```

### Diagnostik (log- resp. rå-respons)

```{r, fig.width=7, fig.height=7}
par(mfrow=c(2,2)); plot(fit_full_log)
```

```{r}
form_full_raw <- y ~ x1_area_km2 + x2_population + x3_urban_percent +
  x6_deciduous_forest_prop + x7_coniferous_forest_prop + x8_mixed_forest_prop +
  x9_shrubland_prop + x10_wetland_prop + x11_agricultural_land_prop +
  x13_inland_water_prop + x14_snow_ice_prop + x15_artificial_surfaces_prop +
  x16_runoff + x17_swine + x18_cattle + x19_treatment_prop + x20_country
fit_full_raw <- lm(form_full_raw, data=df)
summary(fit_full_raw)
```

```{r, fig.width=7, fig.height=7}
par(mfrow=c(2,2)); plot(fit_full_raw)
```

*Log-modellen uppfyller antagandena bättre än rå-modellen.*

## 4.3 Fråga 2 — Samma variabler i Sverige som i grannländer?

**Test av interaktioner och huvudeffekt (Sweden vs Non-Sweden).**

```{r}
form_no_country <- y_log ~ x1_area_km2_log + x2_population_log + x3_urban_percent +
  x6_deciduous_forest_prop + x7_coniferous_forest_prop + x8_mixed_forest_prop +
  x9_shrubland_prop + x10_wetland_prop + x11_agricultural_land_prop +
  x13_inland_water_prop + x14_snow_ice_prop + x15_artificial_surfaces_prop +
  x16_runoff + x17_swine_log + x18_cattle_log + x19_treatment_prop
fit_no_country <- lm(form_no_country, data=df)
fit_step_no_country <- MASS::stepAIC(fit_no_country, direction="both", trace=FALSE)
formula(fit_step_no_country)

form_step_sweden <- update(formula(fit_step_no_country), . ~ . + sweden_group)
fit_step_sweden <- lm(form_step_sweden, data=df)

selected_vars <- all.vars(formula(fit_step_no_country))[-1]
form_step_interact <- as.formula(paste("y_log ~ (", paste(selected_vars, collapse=" + "), ") * sweden_group"))
fit_step_interact <- lm(form_step_interact, data=df)

anova(fit_step_sweden, fit_step_interact)   # interaktioner
anova(fit_step_no_country, fit_step_sweden) # huvudeffekt
```

```{r, fig.width=7, fig.height=7}
par(mfrow=c(2,2)); plot(fit_step_sweden)
```

**Full modell med alla prediktorer:**

```{r}
form_sweden_full <- update(form_no_country, . ~ . + sweden_group)
fit_sweden_full <- lm(form_sweden_full, data=df)
form_sweden_interact_full <- update(form_no_country, . ~ (.) * sweden_group)
fit_sweden_interact_full <- lm(form_sweden_interact_full, data=df)

anova(fit_sweden_full, fit_sweden_interact_full) # interaktioner
anova(fit_no_country, fit_sweden_full)           # huvudeffekt
```

```{r, fig.width=7, fig.height=7}
par(mfrow=c(2,2)); plot(fit_sweden_interact_full)
```

*Interaktioner ej signifikanta; huvudeffekt för Sverige signifikant negativ på log-skalan.*

## 4.4 Fråga 3 — Prediktion (LOOCV) och Duans smearing

**Hjälpfunktioner.**

```{r}
smearing_factor <- function(fit) mean(exp(residuals(fit)))

loocv_rmse <- function(formula, data, response_is_log = FALSE, use_smearing = FALSE) {
  n <- nrow(data); se <- numeric(n); skipped <- 0
  for (i in seq_len(n)) {
    train <- data[-i, , drop=FALSE]; test <- data[i, , drop=FALSE]
    tryCatch({
      fit_i <- lm(formula, data=train)
      if (response_is_log) {
        pred_log <- as.numeric(predict(fit_i, newdata=test))
        if (use_smearing) {
          sm <- smearing_factor(fit_i); pred <- exp(pred_log) * sm - 1
        } else pred <- exp(pred_log) - 1
      } else pred <- as.numeric(predict(fit_i, newdata=test))
      se[i] <- (test$y - pred)^2
    }, error=function(e){ se[i] <<- NA; skipped <<- skipped + 1 })
  }
  sqrt(mean(se, na.rm=TRUE))
}
```

**Tre modellfamiljer.**

```{r}
# A: log y + log-arealer
form_A <- y_log ~ x1_area_km2_log + x2_population_log + x3_urban_percent +
  x6_deciduous_forest_km2_log + x7_coniferous_forest_km2_log + x8_mixed_forest_km2_log +
  x9_shrubland_km2_log + x10_wetland_km2_log + x11_agricultural_land_km2_log +
  x13_inland_water_km2_log + x14_snow_ice_km2_log + x15_artificial_surfaces_km2_log +
  x16_runoff + x17_swine_log + x18_cattle_log + x19_treatment_prop + x20_country
fit_A <- lm(form_A, data=df)
rmse_A <- loocv_rmse(form_A, df, response_is_log=TRUE, use_smearing=TRUE)
adjr2_A <- summary(fit_A)$adj.r.squared

# B: log y + andelar
form_B <- y_log ~ x1_area_km2_log + x2_population_log + x3_urban_percent +
  x6_deciduous_forest_prop + x7_coniferous_forest_prop + x8_mixed_forest_prop +
  x9_shrubland_prop + x10_wetland_prop + x11_agricultural_land_prop +
  x13_inland_water_prop + x14_snow_ice_prop + x15_artificial_surfaces_prop +
  x16_runoff + x17_swine_log + x18_cattle_log + x19_treatment_prop + x20_country
fit_B <- lm(form_B, data=df)
rmse_B <- loocv_rmse(form_B, df, response_is_log=TRUE, use_smearing=TRUE)
adjr2_B <- summary(fit_B)$adj.r.squared

# C: rå y + råa areor
form_C <- y ~ x1_area_km2 + x2_population + x3_urban_percent +
  x6_deciduous_forest_km2 + x7_coniferous_forest_km2 + x8_mixed_forest_km2 +
  x9_shrubland_km2 + x10_wetland_km2 + x11_agricultural_land_km2 +
  x13_inland_water_km2 + x14_snow_ice_km2 + x15_artificial_surfaces_km2 +
  x16_runoff + x17_swine + x18_cattle + x19_treatment_prop + x20_country
fit_C <- lm(form_C, data=df)
rmse_C <- loocv_rmse(form_C, df, response_is_log=FALSE, use_smearing=FALSE)
adjr2_C <- summary(fit_C)$adj.r.squared

data.frame(
  Model = c("LOG-RESP + LOG-AREAS (A)", "LOG-RESP + PROP-AREAS (B)", "RAW-RESP + RAW-ALL (C)"),
  LOOCV_RMSE = c(rmse_A, rmse_B, rmse_C),
  Adj_R2 = c(adjr2_A, adjr2_B, adjr2_C)
)
```

**Stegvis AIC inom familjerna.**

```{r}
fit_A_step <- MASS::stepAIC(fit_A, direction="both", trace=FALSE)
fit_B_step <- MASS::stepAIC(fit_B, direction="both", trace=FALSE)
fit_C_step <- MASS::stepAIC(fit_C, direction="both", trace=FALSE)

summary(fit_A_step)
summary(fit_C_step)
```

**LOOCV för step-modeller.**

```{r}
form_A_step <- formula(fit_A_step)
form_B_step <- formula(fit_B_step)
form_C_step <- formula(fit_C_step)

fit_A_step2 <- lm(form_A_step, data=df)
fit_B_step2 <- lm(form_B_step, data=df)
fit_C_step2 <- lm(form_C_step, data=df)

rmse_A_step <- loocv_rmse(form_A_step, df, response_is_log=TRUE,  use_smearing=TRUE)
rmse_B_step <- loocv_rmse(form_B_step, df, response_is_log=TRUE,  use_smearing=TRUE)
rmse_C_step <- loocv_rmse(form_C_step, df, response_is_log=FALSE, use_smearing=FALSE)

adjr2_A_step <- summary(fit_A_step2)$adj.r.squared
adjr2_B_step <- summary(fit_B_step2)$adj.r.squared
adjr2_C_step <- summary(fit_C_step2)$adj.r.squared

data.frame(
  Model = c("A_step (LOG-RESP + LOG-AREAS, stepAIC)",
            "B_step (LOG-RESP + PROP-AREAS, stepAIC)",
            "C_step (RAW-RESP + RAW, stepAIC)"),
  LOOCV_RMSE = c(rmse_A_step, rmse_B_step, rmse_C_step),
  Adj_R2 = c(adjr2_A_step, adjr2_B_step, adjr2_C_step)
)
```

## 4.5 Slutlig diagnostik (vald modell)

*Vald modell:* den med lägst LOOCV-RMSE (A_step).

```{r, fig.width=7, fig.height=7}
par(mfrow=c(2,2)); plot(fit_A_step2)
```

# 5 Resultat

* **Hela området (log-respons):** $x2_{\log}$ (befolkning), $x16$ (avrinning) och $x17_{\log}$ (svin) positiva; $x19$ (reningsanslutning) negativ. Svaga bidrag från vissa markvariabler.
* **Landjämförelse:** Ingen evidens för olika lutningar mellan Sverige och övriga (interaktioner ej signifikanta). **Sverige** har **lägre intercept** (signifikant).
* **Prediktion (LOOCV):** Bäst RMSE för **A_step** (log $y$, log-areor) med backtransformering via Duans smearing.

# 6 Diskussion

Markandelsvariabler är starkt kollineära; det påverkar tolkning av enskilda koefficienter i fulla modeller. Log-transform av $y$ förbättrar antaganden markant jämfört med rå skala. Enstaka observationer har hög leverage men påverkar inte slutsatserna i den valda modellen. Resultaten gäller givet datakvalitet och valda variabeltransformationer.

# 7 Gruppmedlemmarnas arbetsinsats

Kort arbetsdelning: A ansvarade för dataförberedelser och grafer, B för modellering och selektion, C för CV och rapportstruktur.

# A Appendix: Grafer, R-kod, output om modeller

Kodceller är dolda enligt instruktion. Samtliga diagnostikplottar och sammanfattningar av modeller återfinns i respektive avsnitt ovan. Formler för Duans smearing och LOOCV finns i 4.4.
